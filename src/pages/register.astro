---
import Input from "@/components/input/Input.astro";
import GlobalStyles from "@/components/GlobalStyles.astro";
import Button from "@/components/button/Button";
import { _post } from "@/services/http-client";
import { API } from "@/constants/api";
import { ROUTES } from "@/constants/routes";
import { setUser } from "@/utils/auth";
import type { RegisterError } from "@/types/auth";

let errors = { username: "", email: "", password: "" };

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const username = data.get("username");
    if (!username) {
      errors.username = "닉네임을 입력해주세요.";
    }
    const email = data.get("email");
    if (!email) {
      errors.email = "이메일을 입력해주세요.";
    }

    const password = data.get("password");

    if (!password) {
      errors.password = "비밀번호를 입력해주세요.";
    }

    const isError = Object.values(errors).some(message => message);

    if (!isError) {
      const result = await _post(
        API.USERS,
        JSON.stringify({
          user: {
            username,
            email,
            password,
          },
        }),
      );

      setUser(Astro, result);

      return Astro.redirect(ROUTES.INDEX);
    }
  } catch (error) {
    if (error instanceof Error) {
      console.error(error.message);
    } else if (error instanceof Object) {
      const errorObj = error as RegisterError;
      errors = {
        ...errors,
        email: errorObj.errors.email?.join(", ") || "",
        password: errorObj.errors.password?.join(", ") || "",
        username: errorObj.errors.username?.join(", ") || "",
      };
    }
  }
}
---

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body id="app">
    <GlobalStyles />
    <div class="container">
      <form method="POST">
        <Input
          name="username"
          labelText="닉네임"
          placeholder="닉네임을 입력하세요"
          required="true"
          errorMessage={errors.username}
        />
        <Input
          name="email"
          labelText="이메일"
          placeholder="이메일을 입력하세요"
          required="true"
          errorMessage={errors.email}
        />
        <Input
          name="password"
          labelText="비밀번호"
          placeholder="비밀번호를 입력하세요"
          required="true"
          type="password"
          errorMessage={errors.password}
        />

        <Button type="submit" size="base" color="primary" rounded="base" width="full" client:only="react">
          회원가입
        </Button>
      </form>
    </div>
  </body>
</html>

<style>
  .container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100vh;
  }

  form {
    width: 320px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    row-gap: 20px;
  }
</style>
